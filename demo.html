<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type" />
<meta content="minimum-scale=1.0, width=device-width, maximum-scale=0.6667, user-scalable=no" name="viewport" />
<link href="css/style.css" rel="stylesheet" media="screen" type="text/css" />
<script src="javascript/functions.js" type="text/javascript"></script>
<title>Hemma</title>
<meta content="keyword1,keyword2,keyword3" name="keywords" />
<meta content="To be used for home control" name="description" />
<link rel="apple-touch-icon" href="homescreen.png"/>
<link href="startup.png" rel="apple-touch-startup-image" />
    <script src="http://www.google.com/jsapi?key=ABQIAAAACwBI89C9mmmJL22hG9-DxBRgMwG0ku0wz6SNxwKKTI7DE1glNRSjgE4qGP4SNlSE-JzutfxwbMAvVg" type="text/javascript"></script>
    <script type="text/javascript">
    google.setOnLoadCallback(finishedLoaded);
    google.load("gdata", "1");

    var myService;
    var deviceData = null;
    var feedUrl = "https://www.google.com/calendar/feeds/8d9vj753tdtto51s74ddbvlg3o@group.calendar.google.com/public/full";

    function setupMyService() {
      myService = new google.gdata.calendar.CalendarService('motorvarmare-1');
    }

    function finishedLoaded() {
      setupMyService();
      myService.getEventsFeed(feedUrl, handleMyFeed, handleError);
      queryStates();
    }

function handleMyFeed(result) {
    var entries = result.feed.entry;
    var txt = document.getElementById("u");
    txt.innerHTML = "<p>";
    for (var i = 0; i < entries.length; i++ ) {
       var eventEntry = entries[i];
       var eventTitle = eventEntry.getTitle().getText();
       var eventTimes = eventEntry.getTimes();

       var startTime = eventTimes[0].getStartTime().getDate();
       var endTime = eventTimes[0].getEndTime().getDate();
       var startString = startTime.getHours() + ":" + startTime.getMinutes();
       var endString = endTime.getHours() + ":" + endTime.getMinutes();
       var day = startTime.getDay();

       txt.innerHTML += "<p>" + eventTitle + ": " + startString + "->" + endString + "," + day + "</p>"; 
    }    
    txt.innerHTML += "</p>";
}

function queryStates() {
	var req = new XMLHttpRequest();
	req.open("GET", "serv.php?cmd=state", true);
	req.send(null);
	req.onreadystatechange = function statesResponse() {
		if(req.readyState == 4) {
			var txt = document.getElementById("tellstick");
			deviceData = JSON.parse(req.responseText);
			txt.innerHTML += "<pre>" + deviceData.numDev + "</pre>"
			txt.innerHTML += "<ul>";
			for(var d in deviceData.devices) {
			    var id = parseInt(d) + 1;
			   	//txt.innerHTML += "<li>" + deviceData.devices[d] + "," + id + "</li>";
		    	var chkbox = document.getElementsByName(id)[0];		    	
		    	chkbox.checked = deviceData.devices[d].state=="ON"?true:false;
			}
			txt.innerHTML += "</ul>";
		}
	}
}

function queryDevice(chkbox) {
	$id = chkbox.name;
	if(deviceData != null) {
		//alert(deviceData.devices[id][2]);
		return deviceData.devices[id][2];
	}
	return "off";
}

function callService(chkbox) {
	$cmd = chkbox.checked ? "on" : "off"; 
	$id = chkbox.name;
	var xhReq = new XMLHttpRequest();
	var req = 'serv.php?id=' + $id + '&cmd=' + $cmd;
	xhReq.open("GET", req, true);
	xhReq.send(null);
}

function handleError(e) {
  alert(e.cause ? e.cause.statusText : e.message);
}
    </script>
</head>

<body>

<div id="topbar">
  <div id="title">Hemma</div>
</div>
<div id="content">
<!-- Temperatur frï¿½n temperatur.nu -->
<span class="graytitle">Utetemperatur:
  <script type="text/javascript" src="http://www.temperatur.nu/jsdata.php?t=static&amp;s=hammaro">
  </script>
</span>
<br/>
<br/>
<span class="graytitle">Lampor</span>
<ul class="pageitem">
  <li class="checkbox">
    <span class="name">Nexa dimmer</span>
    <input name="1" type="checkbox" onClick="callService(this);"/>
  </li>
  <li class="checkbox">
    <span class="name">Waveman IP44</span>
    <input name="2" type="checkbox" onClick="callService(this);"/>
  </li>
  <li class="checkbox">
    <span class="name">Nexa inbyggd</span>
    <input name="3" type="checkbox" onClick="callService(this);"/>
  </li>
  <li class="checkbox">
    <span class="name">Lukas B1</span>
    <input name="4" type="checkbox" onClick="callService(this);"/>
  </li>
  <li class="checkbox">
    <span class="name">Lukas B2</span>
    <input name="5" type="checkbox" onClick="callService(this);"/>
  </li>
</ul>
<span class="graytitle">Motorvärmaren</span>
<ul class="pageitem">
  <li class="textbox">
    <div id="u">
       <p>Nästa starttid</p>
    </div>
  </li>
</ul>
<span class="graytitle">Tellstick</span>
<ul class="pageitem">
  <li class="textbox">
    <div id="tellstick">
       <p>Tellstick info</p>
    </div>
  </li>
</ul>
<span class="graytitle">Garaget</span>
<ul class="pageitem">
   <li class="checkbox">
   <span class="name">Portöppnare</span>
   <input name="garageport" type="checkbox" />
</ul>
</div>
<img src="ali.jpg" style="position:absolute; top: -1000px;"/>
<div id="footer">
	<!-- Support iWebKit by sending us traffic; please keep this footer on your page, consider it a thank you for our work :-) -->
	<a class="noeffect" href="http://iwebkit.net">Powered by iWebKit</a></div>

</body>

</html>
